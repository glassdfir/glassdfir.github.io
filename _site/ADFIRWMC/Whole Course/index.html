<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Advanced DFIR Wizard Master Class &#8211; Half Full of Security</title>




<!-- Twitter Cards -->
<meta name="twitter:title" content="Advanced DFIR Wizard Master Class">

<meta name="twitter:site" content="@GlassDFIR">
<meta name="twitter:creator" content="@GlassDFIR">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://jon.glass/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Advanced DFIR Wizard Master Class">

<meta property="og:url" content="http://jon.glass/ADFIRWMC/Whole%20Course/">
<meta property="og:site_name" content="Half Full of Security">





<link rel="canonical" href="http://jon.glass/ADFIRWMC/Whole%20Course/">
<link href="http://jon.glass/feed.xml" type="application/atom+xml" rel="alternate" title="Half Full of Security Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://jon.glass/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://jon.glass/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://jon.glass/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://jon.glass/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://jon.glass/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://jon.glass/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://jon.glass/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://jon.glass/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://jon.glass/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://jon.glass/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="page">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://jon.glass/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://jon.glass/tips/" >Tips and Tricks</a></li>
		  
		    
		    <li><a href="http://jon.glass/about/" >About</a></li>
		  
		    
		    <li><a href="http://jon.glass/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="http://jon.glass/" class="site-logo" rel="home" title="Half Full of Security"><img src="http://jon.glass/images/site-logo.png" width="200" height="200" alt="Half Full of Security logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="http://jon.glass/">Half Full of Security</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Sharpening the ACKs since 2013</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="entry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <h1 class="entry-title">Advanced DFIR Wizard Master Class</h1>
      </header>
      <div class="entry-content">
        <h2 id="welcome">Welcome</h2>

<p>Welcome to the Advanced DFIR Wizard Master Class
by Jonathan Glass</p>
<h2 id="scope-of-this-course">Scope of this Course</h2>

<p>In scope for this class:</p>

<ul>
  <li>Hands on Tools, Tactics, and Techniques of DFIR
    <ul>
      <li>System Administration for Incident Responders</li>
      <li>Computer Science for Incident Responders</li>
      <li>Acquisition and Analysis of Windows artifacts</li>
    </ul>
  </li>
  <li>Examples and Exercises</li>
  <li>Python and PowerShell</li>
</ul>

<p>Out of scope for this class:</p>
<ul>
  <li>The 4 Step Digital Forensics Process</li>
  <li>OSI Model</li>
  <li>Legal crap
    <ul>
      <li>Federal Rules of Evidence</li>
      <li>Chain of custody</li>
    </ul>
  </li>
  <li>Where babies come from</li>
  <li>Important stuff but learn it somewhere else.</li>
</ul>

<h2 id="course-overview">Course Overview</h2>

<ol start="0">
<li>Disclaimers</li>
<li>Windows Remote Admin for Incident Responders</li>
<li>Remote Acquisition of Windows Artifacts</li>
<li>Computer Science for Incident Responders</li>
<li>The Value of Unstructured Analysis</li>
<li>Windows Disk Artifact Analysis</li>
<li>Windows Memory Analysis</li>
<li>Network Analysis</li>
<li>Timelining for Fun and Profit</li>
</ol>

<h2 id="disclaimers">0. Disclaimers</h2>

<h3 id="you-have-to-dig">You have to dig</h3>
<p>As I built this course, I started realizing that perhaps the reader might not understand everything I am talking about. DFIR is not a field where everyone can know everything. It’s just too wide and too deep. Attempting to define every term and provide background on all material would bloat this project beyond scope and diminish the value. If I didn’t cover something, you might have to look it up. Searching for information is the crux of this job.</p>
<h3 id="i-tried-to-keep-it-cheap">I tried to keep it cheap</h3>
<p>In an effort to limit barriers to education, I tried to limit the examples in this course to native, open source, or readily available free tools. If for some reason I mention a commercial tool, it’s because it is worth documenting for completeness. You are going to need a Windows 7 or newer system to play with to put a lot of this to use.</p>
<h3 id="audience">Audience</h3>
<p>I think this course is written to provide examples of DFIR techniques for two groups of people:</p>
<ol>
  <li>Folks that have been in Information Security in one capacity or another and are looking to get into more DFIR work.</li>
  <li>Others who might find this information useful or interesting.</li>
</ol>

<p>This should not be the first computer related course you attempt.</p>

<h3 id="omissions">Omissions</h3>
<p>There are two reasons I didn’t include something in this course:</p>
<ol>
  <li>I didn’t know about it. <em>It happens. Often.</em></li>
  <li>I thought you wouldn’t immediately benefit from knowing it. This career field is deep, wide, and almost any fact about how things work can be refuted with an exception. This course is not designed to be extremely comprehensive, just helpful.</li>
</ol>

<p>Either way, feel free to send me feedback and I will take a look.</p>

<h3 id="tone">Tone</h3>
<p>This is meant to be informal. While that might come across as unprofessional and lacking academic polish, I find it makes the material more digestible and that is point of learning, right?</p>

<h2 id="windows-remote-admin-for-incident-responders">1. Windows Remote Admin for Incident Responders</h2>
<p>Without a system administration background, many incident responders struggle with basic tasks like remotely starting and stopping processes on target machines. Inversely, Incident Responders with sysadmin experience are often faster and more effective. The more familiar you are with native Windows commands, the faster your can operate.</p>

<p>While this course cannot hope to supplant the experience gained by years at your average help desk, I will try to highlight some of the more helpful techniques that get me from A to B.</p>

<h3 id="topics">Topics</h3>

<ul>
  <li>WMI</li>
  <li>MMC</li>
  <li>PsExec</li>
</ul>

<h3 id="wmi">WMI</h3>
<p>One of the most practical skills you can have as a Windows Admin is an understanding of WMI. Windows Management Instrumentation (WMI) is the infrastructure for management data and operations on Windows-based operating systems.</p>

<h4 id="wmi-terminology">WMI Terminology</h4>

<p>The four big vocabulary terms we are going to use for the section are:</p>

<ul>
  <li>Namespaces: A hierarchical structure of WMI objects used to organize Classes</li>
  <li>Classes: A WMI Object that contains fun stuff like Properties and Methods</li>
  <li>Property: Information that can be retrieved.</li>
  <li>Method: Actions that can be taken.</li>
</ul>

<p>For a much better explanation, I recommend: 
https://www.darkoperator.com/blog/2013/1/31/introduction-to-wmi-basics-with-powershell-part-1-what-it-is.html</p>

<h4 id="wmi-example">WMI Example</h4>
<p>To get a list of all processes running on a workstation that match a certain name with process IDs, you could use something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>SELECT processid,name FROM Win32_Process where name='powershell.exe'
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>Term</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Namespace</td>
      <td>Isn’t defined so the default (root\CIMV2) is assumed</td>
    </tr>
    <tr>
      <td>Class</td>
      <td>Win32_Process</td>
    </tr>
    <tr>
      <td>Properties</td>
      <td>processid and name</td>
    </tr>
    <tr>
      <td>Methods</td>
      <td>Not used because we are just listing process info</td>
    </tr>
  </tbody>
</table>

<h4 id="wql">WQL</h4>

<p>WMI Query Language (WQL) is a bastardized version of SQL used to administer WMI. WQL is a deep dark rabbit hole of COM objects that I refuse to try to document but the main statements you need to know are <strong>SELECT, FROM, and WHERE</strong>.</p>

<p>“WQL looks neat but where do I use it?” Great question!  WMI is accessible in a variety of flavors on modern Windows systems. You can leverage WQL with these handy native Windows solutions:</p>
<h4 id="powershell">PowerShell</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>$query = "SELECT processid,name FROM Win32_Process where name='powershell.exe'"
Get-WmiObject -query $query
</code></pre>
</div>

<p><img src="../Images/2018-02-21 12_56_53-Windows PowerShell.png" alt="PowerShell WMI" />
Reference: https://blogs.technet.microsoft.com/heyscriptingguy/2012/07/10/three-easy-ways-to-use-powershell-and-wql-to-get-wmi-data/</p>
<h4 id="wmic">WMIC</h4>
<p>The WMI command-line (WMIC) utility provides a command-line interface for WMI. WMIC is one of my favorite command line applications because it condenses a lot of the</p>

<div class="highlighter-rouge"><pre class="highlight"><code> wmic /node:computername process where (name = "cmd.exe") get processid,name
</code></pre>
</div>

<p><img src="../Images/2018-02-21 13_27_27-Command Prompt.png" alt="WMIC Example" title="WMIC" />
References: 
https://msdn.microsoft.com/en-us/library/aa394531(v=vs.85).aspx
http://jon.glass/blog/lists-some-wmic-commands/</p>

<h4 id="visual-basic-scripting-example-more-or-less-deprecated">Visual Basic Scripting Example (more or less deprecated)</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>strComputer = "."
Set objWMIService = GetObject("winmgmts:\\" &amp; strComputer &amp; "\root\CIMV2")
Set colItems = objWMIService.ExecQuery( _"SELECT * FROM Win32_Process WHERE name=’cscript.exe’",,48)
For Each objItem in colItems
    Wscript.Echo "Name: " &amp; objItem.Name
    Wscript.Echo "ProcessId: " &amp; objItem.ProcessId
Next
</code></pre>
</div>

<p>While VBS is not my first choice, it is good to at least be aware of it because it is still very much in use by admins and attackers alike.</p>

<p>Depending on what 3rd party tools you have in your environment you might be able to utilize these:</p>
<h4 id="python">Python</h4>
<p>The Python WMI module is a lightweight wrapper on top of the pywin32 extensions.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import wmi
c = wmi.WMI ()
for s in c.Win32_Process ():
    if s.Name == "python.exe":
	    print(s.Name, s.ProcessID)
</code></pre>
</div>

<h4 id="bigfix-relevance">BigFix Relevance</h4>

<p>You might not have this in your environment but many companies have clients on endpoints that are designed for system administration or patching that can to utilized to perform incident response functions as well. This is especially true in SMBs where the security guy is also the patching and sysadmin team.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(selects "processid,name from Win32_Process where name = 'explorer.exe'" of wmi)
</code></pre>
</div>

<p><img src="../Images/bigfix.png" alt="BigFix WMI Relevance" /></p>

<h4 id="wmi-classes-of-dfir-interest">WMI classes of DFIR interest</h4>
<p>There is a lot of super geeky DFIR information you can pull out of WMI properties and methods that can give you wizard like powers over remote machines. Here are a few of my favorites :</p>

<table>
  <thead>
    <tr>
      <th>Class</th>
      <th>Properties</th>
      <th>Methods</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Win32_Process</td>
      <td>CommandLine CreationDate Description ExecutablePath Name OSName ParentProcessId ProcessId SessionId</td>
      <td>AttachDebugger Create GetOwner GetOwnerSid Terminate</td>
    </tr>
    <tr>
      <td>Win32_Service</td>
      <td>Description DisplayName InstallDate Name PathName ProcessId ServiceType Started StartMode StartName State Status</td>
      <td>Change ChangeStartMode Create Delete PauseService ResumeService StartService StopService</td>
    </tr>
    <tr>
      <td>Win32_LogonSession</td>
      <td>AuthenticationPackage Description InstallDate LogonId LogonType Name StartTime Status</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td>Win32_NetworkLoginProfile</td>
      <td>AccountExpires BadPasswordCount Description FullName LastLogoff LastLogon LogonServer Name NumberOfLogons PasswordAge PasswordExpires PrimaryGroupId Privileges Profile UserId UserType</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td>Win32_LogicalDisk</td>
      <td>BlockSize Description DeviceID DriveType FileSystem FreeSpace MediaType Name Size VolumeName VolumeSerialNumber</td>
      <td>Chkdsk Reset SetPowerState</td>
    </tr>
    <tr>
      <td>Win32_StartupCommand</td>
      <td>Caption Command Description Location Name SettingID User UserSID</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td>Win32_OperatingSystem</td>
      <td>BootDevice BuildNumber CurrentTimeZone InstallDate LastBootUpTime LocalDateTime Locale Manufacturer Name NumberOfProcesses NumberOfUsers Organization OSArchitecture OSType SerialNumber ServicePackMajorVersion ServicePackMinorVersion SystemDrive</td>
      <td>Reboot SetDateTime Shutdown</td>
    </tr>
  </tbody>
</table>

<h4 id="putting-it-to-work">Putting It To Work</h4>

<p>Scenario: Your detection team says a user on RemoteComputerName received a malicious Word document that downloads a Remote Access Trojan that your antivirus doesn’t have a signature for. From your threat intelligence, this malicious Word document uses a macro to drop an EvilFile.exe in the users Temp directory.</p>

<p>Let’s verify the alert..maybe the user didn’t open the Word doc…(yeah right)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wmic /node:RemoteComputerName process where (name like '%scchost.exe%') get executablepath,processid,parentprocessid /format:list
    ExecutablePath=C:\Users\Username\AppData\Local\Temp\Scchost.EXE
    ParentProcessId=1040
    ProcessId=3712
</code></pre>
</div>

<p>Crap. Looks like the user might have clicked on it. Let’s verify that parent process just to be sure:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wmic /node:RemoteComputerName process where (ProcessId = 1040) get executablepath /format:list
    ExecutablePath=C:\Program Files\Microsoft Office\Office16\WINWORD.EXE
</code></pre>
</div>

<p>Double crap. Looks like this is a confirmed compromise of a workstation. 
For fun and containment, let’s kill that malicious process using a WMI method:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wmic /node:RemoteComputerName process where (name ='Scchost.exe') CALL Terminate
Executing (\\RemoteComputerName\ROOT\CIMV2:Win32_Process.Handle="3712")-&gt;Terminate()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
        ReturnValue = 0;
};
</code></pre>
</div>

<p>For even MORE fun, like copy that malicious file to an analysis share so we can get a better look at it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wmic /node:RemoteComputerName process call create "xcopy  /Y C:\Users\Username\AppData\Local\Temp\Scchost.EXE \\AnalysisShare\Scchost.exe.bin" 
</code></pre>
</div>

<p>For a lot less fun, let’s call the User explain the situation, shut it down remotely, and go get the workstation to determine what this malware did :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>wmic /node:RemoteComputerName os call Shutdown
</code></pre>
</div>

<p><em>Disclaimer: This scenario is largely BS. Malware isn’t usually this easy to kill and as more work becomes remote, it is increasingly rare to physically walk over to the user’s cube and take their workstation.</em></p>

<h3 id="mmc">MMC</h3>
<p>I imagine I scared some of off you with all that “coding” and “command line stuff”. While there are GUIer options to accomplish Windows administration tasks, they aren’t as efficient or sexy. If you are against coding all together, there is an X at the top right or left of your browser. We can part ways now and no one’s feelings need to get hurt. For the sake of completeness, I will cover MMC which is a GUI and can do Windows admin tasks but it is not my “go to”.
According to the big M, the Microsoft Management Console (MMC) is an extensible common presentation service for management applications.
<img src="../Images/2018-02-22-MMC.png" alt="MMC" title="MMC" /></p>

<p>This console gives you access to some a lot of administration tools.</p>
<ul>
  <li>Computer Management Snap-In
    <ul>
      <li>System Tools
        <ul>
          <li>Task Scheduler
            <ul>
              <li>Good for running processes remotely, shutting down workstations, and whatnot</li>
            </ul>
          </li>
          <li>Event Viewer
            <ul>
              <li>Good for remotely viewing logs but not great</li>
            </ul>
          </li>
          <li>Local Users and Groups
            <ul>
              <li>Good for administering local user accounts</li>
            </ul>
          </li>
          <li>Device Manager
            <ul>
              <li>Handy when you need to see if a USB is plugged in</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Storage
        <ul>
          <li>Disk Management
            <ul>
              <li>Also handy for seeing if external media is plugged in</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Services and Applications
        <ul>
          <li>Services</li>
          <li>Allows for administration of Windows services. (start, pause, stop)</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>I don’t use this much for IR but if you are in an environment where you don’t have any other tools, this is a native GUI solution that might get you where you need to go.</p>

<h3 id="pstools">PsTools</h3>

<p>Way way way back in 1996, Mark Russinovich and Bryce Cogswell created a little company called Winternals Software LP that created a bunch of software to help administer Windows 2000 boxes. Long story short…in 2006 Microsoft bought the company and all their tools now known as <a href="https://docs.microsoft.com/en-us/sysinternals/">Windows Sysinternals</a>. There is a cornucopia of awesome tools that I will mention throughout the duration of this course but for now we are going to focus on some of the PsTools Suite I find most handy. While you can accomplish all of these functions via WMI via PowerShell or WMIC, these tools are helpful for those who prefer tools with a dedicated tasks and help menus. There is absolutely no shame in that but I found, the more comfortable I become with WMI scripting, the less I needed most of this suite.</p>

<h4 id="windows-admin-using-pstools-suite">Windows Admin using PsTools Suite</h4>

<table>
  <thead>
    <tr>
      <th>Tool</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec/">PsExec</a></td>
      <td>execute processes remotely</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pskill/">PsKill</a></td>
      <td>kill processes by name or process ID</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pslist/">PsList</a></td>
      <td>list detailed information about processes</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon/">PsLoggedOn</a></td>
      <td>see who’s logged on locally and via resource sharing</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice/">PsService</a></td>
      <td>view and control services</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psshutdown/">PsShutdown</a></td>
      <td>shuts down and optionally reboots a computer</td>
    </tr>
  </tbody>
</table>

<p>Most of the PsTools suites are fairly straightforward and require almost no explanation but PsExec is robust enough that it bears covering.</p>

<h4 id="psexec">PsExec</h4>
<p>From <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">Microsoft</a></p>

<blockquote>
  <p>“PsExec is a light-weight application that lets you execute processes
on other systems, complete with full interactivity for console
applications, without having to manually install client software.
PsExec’s most powerful uses include launching interactive
command-prompts on remote systems and remote-enabling tools like
IpConfig that otherwise do not have the ability to show information
about remote systems.”</p>
</blockquote>

<p>PsExec is to DFIR as a good blaster is to Han Solo.  I can’t tell you how many times PsExec has saved my bacon. Not to mention how many times I have pulled off some nifty DFIRfu with it’s various options. Everytime I read PsExec’s Usage I learn something new that it does.</p>

<h5 id="example-elevating-to-system-account">Example: Elevating to System Account:</h5>
<p>One of my favorite tricks is to run remote processes as the System account and not a puny User account as seen below:
<img src="../Images/2018-02-22 11_43_24-__192.168.164.130_ cmd.png" alt="PsExec As System" />
This grants a higher level of privileges and leaves less of a footprint on the remote machine. I rarely want to use my own account for anything on a remote machine unless I have to.</p>

<p>Pro Tip: If you are copying evidence from a remote machine to a collection share using PsExec to run as the system account, make sure the share is configured to grant Computer account of the target workstation write permission or you will get errors that will run you in circles. Doesn’t matter if your admin account has rights if you are running as the Computer.</p>
<h5 id="example-copying-an-utility-and-then-executing-it-on-a-remote-system-">Example: Copying an Utility and then Executing it on a Remote System :</h5>
<p><img src="../Images/2018-02-25 13_08_02-Administrator_ Command Prompt.png" alt="enter image description here" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>PsExec.exe \\192.168.164.130 -c RawCopy.exe /FileNamePath:C:0 /OutputPath:\\ForensicServer\dropbox\ /OutputName:$MFT
</code></pre>
</div>

<p>There is a lot going on in this example so let’s break it down…</p>

<ul>
  <li>I am using PsExec to remotely execute RawCopy on a remote host with an IP of 192.168.164.130.</li>
  <li>Since the remote host probably doesn’t have RawCopy, a third party tool, laying around, I used the <strong>-c</strong> flag to copy the program over to the remote system. The <strong>-f</strong> flag is used just in case it was already there so we can overwrite it.</li>
  <li>RawCopy’s options are fairly straightforward. I am copying the Master File Table (record 0) from C:\$MFT on the remote machine to  my \\ForensicServer\dropbox share for analysis</li>
  <li>After RawCopy finished, I check my dropbox folder to confirm the $MFT landed safely.</li>
</ul>

<h5 id="example-interacting-with-the-user">Example: Interacting with the User:</h5>
<p>PsExec runs a console session by default but can be configured to interact with the logged on user’s session using the <strong>-i</strong> option. This is helpful in those rare instances where you need to user to see something you are doing. 99% of the time the user is going to be logged in under the second session or session 1. It’s not often but I have used this a couple times over the years.
In this example, I use PsExec to create two instances of notepad.exe on my local machine. One is in user session and visible, the other is not. 
<img src="../Images/2018-02-26 14_04_26-Sessions.png" alt="enter image description here" /></p>

<p>The <strong>-d</strong> flag is used to detach the PsExec session from the child process so we don’t have to wait until notepad exits to continue. This is very handy for DFIR collection scripts that might take a while. Detach the process and let it do it’s thing. I like to use <strong>-d</strong> on targets that are on flakey VPN connections so that if the connection drops, the process is still running on the remote system. The obvious downside is, you can’t interact with the session after it is detached.</p>

<h5 id="example-running-commands-on-multiple-machines">Example: Running commands on multiple machines</h5>
<p>PsExec allows you to perform administrative tasks on multiple workstations but you can only interact with one at a time. Here is an example of getting a command shell on two different machines:
<img src="../Images/2018-02-27 08_23_19-Administrator_ Command Prompt.png" alt="enter image description here" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>PsExec.exe \\DESKTOP-132B1OL,192.168.164.130 cmd
</code></pre>
</div>

<p>I can’t access the second machine until I exit the session with the first one. To speed that process up, using the <strong>-d</strong> to detach the session from the process will make it much faster.</p>

<p><img src="../Images/2018-02-26 18_38_25-Administrator_ Command Prompt.png" alt="enter image description here" /></p>

<p>When would you ever need to do this? Let’s say you want to collect artifacts from the two machines involved in an alert you received from your detection team. You could bust out your PsExec skills and do something like this:</p>

<p><img src="../Images/2018-02-27 08_23_19-Administrator_ Command Prompt.png" alt="Advanced PsExec Copy" /></p>

<p><strong>Breakdown:</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>#Bit of a cheat code to copy a file over before using it.
\tools\PsExec.exe \\DESKTOP-132B1OL,RemoteMachine -d -f -c \Tools\RawCopy.exe
</code></pre>
</div>

<p>What does this do? PsExec will copy \Tools\RawCopy.exe to the c:\Windows folder of DESKTOP-132B1OL and try to run it. Same with RemoteMachine. RawCopy needs all sorts of command line options so it will gracefully exit BUT the tool has be in place. Why didn’t i use the <strong>-c</strong> switch? I’ll show you:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>\tools\PsExec.exe \\DESKTOP-132B1OL,RemoteMachine -d cmd /c c:\Windows\RawCopy.exe /FileNamePath:C:0 /OutputPath:"\\vmware-host\Shared Folders\Evidence\" /OutputName:^%computername^%-$MFT
</code></pre>
</div>

<p>On my evidence share, I am looking to have one file from each of these workstations. To make sure I can tell the two $MFTs apart, I used the environment variable %COMPUTERNAME% from the remote computer for file name passed to RawCopy.</p>

<p>To access the remote environment variables, I needed to use cmd to launch RawCopy which means I couldn’t use the <strong>-c</strong> to copy it over in one foul swoop. By using the carets to escape the percent signs, like this <code class="highlighter-rouge">^%computername^%-$MFT</code>, you can pass the variable to the next command interpreter. If you don’t, your command prompt will interpret it and save all of the file names as YOUR computer name and overwrite each other. Took me a second to figure that out.</p>

<p>If all this sounds convoluted, you’re paying attention. The point of this course highlight some more complicated methods of approaching the litany of challenges you will encounter during your DFIR day.</p>

<h2 id="remote-acquisition-of-windows-artifacts">2. Remote Acquisition of Windows Artifacts</h2>
<p>Some folks reading this are convinced that Incident Response is all done through Endpoint Detection and Response solutions and in 2018 no one drops collection scripts to gather artifacts for analysis. Those people are wrong.</p>

<p>The first thing you should know is you will run into problems. Even when your collection tool is working perfectly; network connections drop, hard drives run out of room, antivirus and data loss prevention software will freak out… this is going to happen. Embrace it.</p>

<p>This chapter is going to cover as many of the lessons learned as I can think of.</p>

<h3 id="issues-with-tools-for-remote-file-acquisition">Issues with Tools for Remote File Acquisition</h3>

<p>This can quickly get religious but I am not a fan of most commercial tools. Many do WAY too much stuff I don’t need or want for my OCD to handle. I am not going to bad mouth any particular vendor but there are a lot of solutions that just don’t work for my exact needs.</p>

<p>Things I have found annoying about collection tools:</p>

<ul>
  <li>Some tools require special dongles which is often not practical with modern global enterprises.</li>
  <li>Some use netcat like functionality to talk directly from your workstation to target which triggers NIDS and is blocked by NIPS.</li>
  <li>Some won’t copy or even find some files on the target because they are locked by the OS or a third party tool like AV or DLP.</li>
  <li>Some free tools get flagged by AV because they are not signed or what they are written in.</li>
  <li>Some tools take too long and then produce too little.</li>
  <li>Some tools are primarily geared for Law Enforcement and don’t cater to the enterprise teams that will probably never testify in court.</li>
  <li>Most are WAY overpriced for what they offer.</li>
</ul>

<p>Enough of my complaining. After a little science, I will explain my reasoning for the tools I use and let you figure out what works best for your work flow and environment.</p>

<h4 id="the-underlying-mechanics-of-copying-locked-files-on-windows">The Underlying Mechanics of Copying Locked Files on Windows</h4>

<p>Before we discuss tools and examples, an understanding of the mechanics of the NTFS filesystem is helpful to ensure you can adapt and overcome when various things get in between you and your artifacts. Here is a piece of DFIRfu using completely native windows commands. Admittedly, this is more DF than IR and I know it is a lot of hexadecimal but stick with me…
<img src="../Images/$MFTdataruns.png" alt="MFT Data Runs" /></p>

<p><strong>Breakdown</strong></p>

<ul>
  <li><code class="highlighter-rouge">fsutil.exe fsinfo ntfsInfo c:</code>
    <ul>
      <li>This command shows us a bunch of useful information for how data is stored on this Volume but all we need for now is the Bytes per Cluster: 4096.</li>
      <li>We could have used something like this:
  <code class="highlighter-rouge">wmic volume where (name="c:\\") get blocksize</code></li>
      <li>This tells us that the file system allocates space to files in chunks of 4096 bytes. Even if the file is smaller, it gets the whole 4K to itself.</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">fsutil.exe file queryextents c:\$MFT</code>
    <ul>
      <li>This command shows use the clusters allocated to the $MFT. I pick on the $MFT a lot in my examples for two reasons : it contains almost all of the file system information on the system and it is not directly accessible through the operating system.</li>
      <li>This command outputs three columns of information:
        <ul>
          <li><strong>VCN</strong>: Virtual Cluster Numbers are used to sequence chunks of allocated data kinda like numbered puzzle pieces.</li>
          <li><strong>Clusters</strong>: This is the number of contiguous Clusters allocated per Data Run.</li>
          <li><strong>LCN</strong>: Logical Cluster Numbers are basically used as addresses. This run of contiguous data begins at X number of clusters from the beginning of the volume.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">echo Size of $MFT in Bytes: &amp;&amp; set /a (0xC820 + 0x4720) * 4096</code>
    <ul>
      <li>This is just an example of how to do math on the Windows command line.</li>
      <li><code class="highlighter-rouge">set /a</code> can be used for sorts of fun stuff like converting hex to decimal and arithmetic.</li>
      <li>Here I am adding the number of clusters from the first data run and second data run to determine the total number of clusters allocated to the $MFT. Since we know the clusters are 4096 bytes large, we multiple to determine the number of bytes allocated to the $MFT.</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">dir "\\vmware-host\Shared Folders\Evidence"</code>
    <ul>
      <li>Here I am just showing you that the $MFT we collected from the previous examples using RawCopy is in fact the same size as the crazy math we just did.</li>
    </ul>
  </li>
</ul>

<p>Here is another way to look at that information:
<img src="../Images/$MFTallocatedspace.png" alt="enter image description here" />
That $MFT only has two but it is common for larger files to have many data runs:
<img src="../Images/webcachedataruns.png" alt="enter image description here" />
This WebCacheV01.dat file has 25 runs spread out all over the volume.</p>

<p><strong>The Point</strong></p>

<p>To access locked files on a live Windows system, your acquisition tool needs to:</p>

<ol>
  <li>Determine what physical clusters have been allocated for that file. This is stored in terms of LCN and number of clusters <em>(inside the $MFT as it just so happens, but we will cover that later)</em>.</li>
  <li>Open the Volume for direct read access.</li>
  <li>Seek to the offset of the LCN on disk and read the numbers of clusters specified. Repeat as needed for all Data Runs.</li>
  <li>Write the collected information to an output file in the sequence specified by the VCNs.</li>
</ol>

<p>«««&lt; HEAD
Here is an example using 10 lines of Python:
<img src="../Images/Extents2Raw.png" alt="Extents2Raw" /></p>

<p>Piece of cake right? Well the first 3 steps can trip up many tools for one reason or another.</p>

<h4 id="pros-and-cons">Pros and Cons</h4>
<p>=======
Piece of cake right? Well the first 3 steps can trip up tools for one reason or another.</p>

<h4 id="tools-i-use-for-remote-file-acquisition">Tools I use for Remote File Acquisition</h4>

<p>Here is a table of tools I like enough to mention in no particular order:</p>

<table>
  <thead>
    <tr>
      <th>Tool</th>
      <th>Pros</th>
      <th>Cons</th>
      <th>Cost</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/jschicht/RawCopy">RawCopy</a></td>
      <td>&lt;ul&gt;&lt;li&gt;Does a good job copying locked files.&lt;/li&gt;&lt;li&gt;Can reference files by path or record number.&lt;/li&gt;&lt;li&gt;Open Source&lt;/li&gt;&lt;/ul&gt;</td>
      <td>&lt;ul&gt;&lt;li&gt;Written in AutoIt&lt;/li&gt;&lt;li&gt;Includes the ability to send raw TCP packets which gets it flagged as a Hack Tool by some A/V vendors.&lt;/li&gt;</td>
      <td>Free</td>
    </tr>
    <tr>
      <td><a href="http://www.sleuthkit.org/sleuthkit/">SleuthKit</a></td>
      <td>&lt;ul&gt;&lt;li&gt;Written by Brian Carrier, author of File System Forensic Analysis&lt;/li&gt;&lt;li&gt;Open Source&lt;/li&gt;&lt;li&gt;Python Bindings&lt;/li&gt;&lt;li&gt;Succeeds when others fail.&lt;/li&gt;&lt;/ul&gt;</td>
      <td>&lt;ul&gt;&lt;li&gt;Tools designed to display file contents on STDOUT&lt;li&gt;Not actually designed for remote file acquisition. <em>(Listing this as a con is like getting mad a hammer for not cutting wood though.)</em>&lt;/ul&gt;</td>
      <td>Free</td>
    </tr>
    <tr>
      <td>Surge</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE0ODU4NDMwNDRdfQ==
-->
<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p>origin/master</p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>

      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2018 Jon Glass. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	<a href="https://twitter.com/GlassDFIR" title="Jon Glass on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	
	
	
	
	<a href="https://github.com/GlassDFIR" title="Jon Glass on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="http://jon.glass/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://jon.glass';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://jon.glass/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://jon.glass/assets/js/scripts.min.js"></script>




</body>
</html>
