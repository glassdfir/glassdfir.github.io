---
layout: post
title: My analysis of Dridex malware (Part Two)
date: 2015-03-23 19:01:16.000000000 -04:00
categories: blog
---
<p>In the last post, I analyzed a dropper associated with Dridex. This post will focus on analyzing the assa.exe that was dropped.</p>

<p>File name: assa.exe<br />
MD5: 8a996e195337c68d3c4b0a82a285f70b<br />
SHA1: 5bf78a6cd73e20393960a4187833028bee179dd6<br />
SHA256:21f596cae35b2cb7e61c1a93bfa60ebf590d60b9b9f936f820aec96932ca11c7<br />
(I am throwing the hashes in these posts to help my fellow Googlers.)</p>
<p>To analyze assa.exe, I used a handful of tried and true tools:<br />
<a href="https://technet.microsoft.com/en-us/sysinternals/bb842062.aspx">Sysinternals</a> tools (<a href="https://technet.microsoft.com/en-us/sysinternals/bb896645">procmon</a>, <a href="https://technet.microsoft.com/en-us/sysinternals/bb897441.aspx">sigcheck</a>, etc...)<br />
<a href="https://www.wireshark.org/">Wireshark</a><br />
ResEdit<br />
Some batch scripting<br />
VMware Workstation</p>
<p>So here is how I did the behavioral analysis of the assa.exe.</p>
<ol>
<li>I opened a Windows 7 32-bit SP1 VM I had laying around that has Sysmon installed on it.</li>
<li>I fired up procmon and wireshark.</li>
<li>Took a snapshot in VMware so I could revert back to clean state as needed.</li>
<li>Copied the assa.exe to C:\Users\User\Desktop and ran it.</li>
<li>Waited about...3 mins.</li>
<li>Saved the Procmon output, Wireshark pcap, sysmon log, and a memory dump to a share.</li>
<li>Reverted to snapshot.</li>
</ol>
<p>First thing I did was read the Process Monitor log. I opened the file up from the network share and setup a filter to only look at assa.exe for now.<br />
<a href="https://jon.glass/wp-content/uploads/2015/03/Screen-Shot-2015-03-23-at-9.00.44-AM.jpg"><img src="{{ site.baseurl }}/images/Screen-Shot-2015-03-23-at-9.00.44-AM-300x172.jpg" alt="Screen Shot 2015-03-23 at 9.00.44 AM" width="300" height="172" class="aligncenter size-medium wp-image-630" /></a><br />
If you are new to ProcMon, the signal to noise ratio can make it difficult to read but here are the highlights:<br />
<script src="https://gist.github.com/glassdfir/5c37128a7be49d56f7ea.js"></script><br />
Assa.exe then generates the following network traffic:<br />
<script src="https://gist.github.com/glassdfir/a694add3275f0c617577.js"></script><br />
I will take a crack at decoding that blob of nonsense later but for now, I will keep going.<br />
<script src="https://gist.github.com/glassdfir/abe43cd9e06d72e34d01.js"></script><br />
This looks to be the a third stage payload. For those who aren't familiar with the IRP_MJ_CREATE Operation, <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff548630%28v=vs.85%29.aspx">Microsoft</a> says </p>
<blockquote><p>The I/O Manager sends the IRP_MJ_CREATE request when a new file or directory is being created, or when an existing file, device, directory, or volume is being opened. </p></blockquote>
<p>When hashed, the tmp file gave me nothing to work with. No matter. I'll come back to that later as well.<br />
<script src="https://gist.github.com/glassdfir/1adbeb8d2c7cf1384569.js"></script><br />
0928AC45920A48C1E11D207E55797CF0 appears to be a 32 bit tracking signature for the infected computer. The idea is you need a way to uniquely identify 100,000 computers that could have very similar characteristics. Computer Names, User names, IP/MAC addresses by themselves could cause collisions in a botnet. The likelihood that another machine is going have the same ComputerName, Username, InstallDate and MachineGuid starts to become very slim.<br />
A little later in the Procmon output we see this:<br />
<script src="https://gist.github.com/glassdfir/e643cd82cc7c86edff84.js"></script><br />
Since the tmp file is a dll, that means we can look at it with a wide variety of Tools. I grabbed ResEdit:<br />
<a href="https://jon.glass/wp-content/uploads/2015/03/reseditor.png"><img src="{{ site.baseurl }}/images/reseditor-1024x552.png" alt="reseditor" width="780" height="420" class="alignleft size-large wp-image-639" /></a><br />
So this file is dressed up like a copy of c:\Windows\System32\DInput8.dll from copy of Windows XP Pro with the Russian language pack. In case, anyone is curious, there are some subtle differences between the real and the fake. Most importantly, the real one is digitally signed.<br />
<a href="https://jon.glass/wp-content/uploads/2015/03/sigcheck.png"><img src="{{ site.baseurl }}/images/sigcheck-300x222.png" alt="sigcheck" width="300" height="222" class="alignleft size-medium wp-image-641" /></a><br />
DInput8.dll is a valid Windows DLL used for <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ee418998(v=vs.85).aspx">Microsoft DirectInput</a>. DirectInput enables an application to retrieve data from input devices even when the application is in the background. At this point, I do not think this technology has anything to do with this malware's capabilities.</p>
<p>Finally, we see ASSA.EXE gracefully exits after running for only 4.0371401 seconds by my math.<br />
<script src="https://gist.github.com/glassdfir/67323a8a5b8fb831a5e3.js"></script></p>
<p>To summarize, ASSA.EXE's purpose in life is 3 fold:</p>
<ol>
<li>Download the latest third stage from 95.163.121.33:80. The payload I received was a PE file cleverly disguised as a valid but unsigned Windows driver.
</li>
<li>Run the third stage payload using Rundll32.exe</li>
<li>Tag the target computer with a unique botnet identifier based on specific characteristics found in the Registry. The tag is a 32-bit hex string stored HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\CLSID\{354BCA22-B264-2DB5-DC3F-114C655B5C92}\ShellFolder\0</li>
</ol>
<p>I am going to dive deeper into the this tmp/dll file in the next blog post because that is where the really interesting stuff happens.</p>
