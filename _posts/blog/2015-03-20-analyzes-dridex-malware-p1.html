---
layout: post
title: My analysis of Dridex malware (Part One)
date: 2015-03-20 11:11:48.000000000 -04:00
categories: blog
---
<p>I had a few unscripted hours to kill before bed so I snagged <a href="https://malwr.com/analysis/MzkzMTk3MzBlZGQ2NDRhY2IyNTc0MGI5MWQwNzEwZmQ/" target="_blank">a Dridex sample</a> from <a href="http://malwr.com" target="_blank">Malwr.com</a> to see what all of the fuss was about.

  According to <a href="https://threatpost.com/dridex-banking-trojan-spreading-via-office-macros/110255" target="_blank">ThreatPost</a>, Dridex is a descendent of <a href="https://threatpost.com/cridex-malware-takes-lesson-from-gameover-zeus/107785" target="_blank">Cridex, Feodo or Bugat and is in the GameOver Zeus family</a>. </p>
<p>File Name:064016.doc<br />
MD5: 8f6a30149bc8970e9233037533c044cd<br />
SHA1: 9515fbfb66624cb0684c32007f6b2a8b9e5756fc<br />
SHA256: f9b874f9ccf803abaeaaf7af93523ee140f1929837f267378c89ed7b5bf174</p>
<p>This file was tagged as Dridex but it looks like a malicious Word 2003 XML-based document. This is a first stage dropper for Dridex. Since it is an XML document, a plain-text format, it shouldn't be too hard to tear apart.<br />
First, I will start by running cat against the sample file to read the strings.<br />
<a href="https://jon.glass/wp-content/uploads/2015/03/Screen-Shot-2015-03-20-at-9.08.45-AM.png"><img src="{{ site.baseurl }}/images/Screen-Shot-2015-03-20-at-9.08.45-AM-1024x731.png" alt="Screen Shot 2015-03-20 at 9.08.45 AM" width="780" height="557" class="aligncenter size-large wp-image-606" /></a><br />
There is a crap load of interesting metadata in here. Here are a few interesting tidbits:<br />
<script src="https://gist.github.com/glassdfir/76a8427cdfc825bb7ca5.js"></script><br />
So far we can tell that this Word 2003 document was created on 3/14/15, changed 6 times, last saved on 3/16/15. It was created on a Windows system running Office 2003 with the Russian language pack installed. There is also author and company names that can be helpful for setting up signatures. Those values are easily changed so while they are not definitive for attribution, they add context to the investigation. Finally, we can also tell that this document contains a macro. </p>
<p>To investigate this macro, I grabbed a copy of <a href="https://twitter.com/didierstevens">Didier Stevens'</a> <a href="http://blog.didierstevens.com/programs/oledump-py/">oledump.py</a>.</p>
<blockquote><p>oledump.py is a program to analyze OLE files (Compound File Binary Format). These files contain streams of data. oledump allows you to analyze these streams. Many applications use this file format, the best known is MS Office. .doc, .xls, .ppt, … are OLE files (docx, xlsx, … is the new file format: XML insize ZIP).</p></blockquote>
<p>So to get the lay of the land, I start with running oledump.py without any options:<br />
<strong>python oledump.py 064016.doc </strong><br />
<a href="https://jon.glass/wp-content/uploads/2015/03/Screen-Shot-2015-03-20-at-9.44.06-AM.png"><img src="{{ site.baseurl }}/images/Screen-Shot-2015-03-20-at-9.44.06-AM-1024x562.png" alt="Screen Shot 2015-03-20 at 9.44.06 AM" width="780" height="428" class="alignleft size-large wp-image-610" /></a> From this we can see this Word doc contains an embedded file called editdata.mso which contains seven data streams. Three of the data streams are flagged as macros: A3:'VBA/Module1', A4:'VBA/Module2', A5:'VBA/ThisDocument'. Here is what these look like when dumped:<br />
<strong>python oledump.py 064016.doc -s A4 -v</strong><br />
<script src="https://gist.github.com/glassdfir/3cc052b5899992ac2f1e.js"></script><br />
As far as I can tell, VBA/Module2 does absolutely nothing. These are nonsensical functions designed to confuse heuristic scanners.<br />
<strong>python oledump.py 064016.doc -s A5 -v</strong><br />
<script src="https://gist.github.com/glassdfir/2ff987ad1ae5d2777205.js"></script><br />
This calls the HBjkbjBJKBL subroutine found in the A3 stream when the document is closed. This is an intentional technique used to evade sandbox analysis.<br />
<strong>python oledump.py 064016.doc -s A3 -v</strong><br />
<script src="https://gist.github.com/glassdfir/4085395fb7ac61d78afb.js"></script><br />
This is the payload. Can't see it? Looks like the payload was converted to hexadecimal to further obfuscate its intent. We will apply a little BashFu and ...<br />
<a href="https://jon.glass/wp-content/uploads/2015/03/Screen-Shot-2015-03-20-at-11.48.10-AM.png"><img src="{{ site.baseurl }}/images/Screen-Shot-2015-03-20-at-11.48.10-AM-1024x429.png" alt="Screen Shot 2015-03-20 at 11.48.10 AM" width="780" height="327" class="alignleft size-large wp-image-615" /></a><br />
Voilà! We have our payload. Lets break these commands down:<br />
<script src="https://gist.github.com/glassdfir/ef374b97445cdb4a4ec3.js"></script><br />
You'll notice you don't see any of this in the Cuckoo report. This is because Cuckoo is looking for the infection to occur immediately after opening the document. This does nothing until you try to close it. Well played bad guys. Well played.</p>
<p>In my next post I will give you my run down of the assa.exe executable. Stay tuned.</p>
